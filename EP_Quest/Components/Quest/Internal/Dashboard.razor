@using EP_Quest.Models
@using EP_Quest.Services.Common
@using Microsoft.EntityFrameworkCore
@inject IQuestRepository Repository
@inject NotificationService NService

<div class="cards">
    @if (IsInitialized)
    {
        @foreach (var step in _steps)
        {
            <div class="card @step.LockIdentifier @step.Selection"
                 @onmouseover="() => HoverCard(true, step)"
                 @onmouseout="() => HoverCard(false)"
                 @onclick="() => SelectCard(step.GetNumber())">
                @step.GetName()
            </div>
        }
    }

</div>
<div class="description-section">
    <span class="description-text">
        @_stepDescription
    </span>
    <div class="buttons-container">
        <div class="nav-button" @onclick="ToInstructions">Instructions</div>
        <div class="nav-button" style="visibility: @_playButtonVisibility" @onclick="PlayStep">Play</div>
    </div>
</div>

@code {
    private bool IsInitialized = false;

    struct Step
    {
        public string LockIdentifier;
        public string Selection = string.Empty;

        private Models.Step _step;


        public Step(Models.Step step)
        {
            _step = step;
            LockIdentifier = _step.IsLocked ? "lock" : "unlock";
        }
        public Step(Models.Step step, string selection)
        {
            _step = step;
            LockIdentifier = _step.IsLocked ? "lock" : "unlock";
            Selection = selection;
        }
        public bool IsLocked() => _step.IsLocked;
        public Models.Step Get() => _step;
        public string GetName() => _step.Name;
        public int GetNumber() => _step.Number;
        public string GetDescription() => _step.Description;
        public string GetContent() => _step.Content;
    }

    [Parameter]
    public EventCallback ToInstructions { get; set; }
    [Parameter]
    public EventCallback ToSelectedStep { get; set; }

    private List<Step> _steps;
    private string _stepDescription = string.Empty;
    private Step _selectedStep = default;
    private string _playButtonVisibility = "hidden";


    protected override async Task OnInitializedAsync()
    {
        await Init();
        NService.SubscribeNotification(SomeHandler);
        IsInitialized = true;
    }
    public async Task SomeHandler(NotificationName notificationName)
    {
        Repository.UpdateContext();

        if (notificationName == NotificationName.UnlockNextStep)
            await Init();

        await InvokeAsync(StateHasChanged);
    }
    public async Task Init()
    {
        _stepDescription = string.Empty;
        _selectedStep = default;
        _playButtonVisibility = "hidden";
        _steps = await Repository.Steps.OrderBy(x => x.Number).Select(x => new Step(x)).ToListAsync();
    }
    private void HoverCard(bool isOver, Step step = default)
    {
        if (isOver)
        {
            _stepDescription = step.IsLocked() ? "***" : step.GetDescription();
            return;
        }

        _stepDescription = string.Empty;

        for (var i = 0; i < _steps.Count; i++)
            if (_steps[i].Selection != string.Empty)
                _stepDescription = _steps[i].IsLocked() ? string.Empty : _steps[i].GetDescription();
    }
    private void SelectCard(int stepNumber)
    {
        var mask = 1;

        for (int i = 0; i < _steps.Count; i++)
        {
            if (_steps[i].Selection != string.Empty)
            {
                _steps[i] = new Step(_steps[i].Get(), string.Empty);
                _selectedStep = default;
                mask <<= 2;
                continue;
            }

            if (_steps[i].GetNumber() == stepNumber)
            {
                _steps[i] = new Step(_steps[i].Get(), "selected-step");
                _selectedStep = _steps[i];
                _playButtonVisibility = _selectedStep.IsLocked() ? "hidden" : "visible";
                mask <<= 3;
            }
        }

        if (mask == 4)
        {
            _playButtonVisibility = "hidden";
            _selectedStep = default;
        }
    }
    private async Task PlayStep()
    {
        var currentStep = Repository.Steps.Where(x => x.Number == _selectedStep.GetNumber());

        if (currentStep.FirstOrDefault() == null)
            throw new Exception();

        await ToSelectedStep.InvokeAsync();

        if (currentStep.FirstOrDefault().Start != null)
            return;

        await currentStep.ForEachAsync(x =>
        {
            x.Start = DateTime.Now.ToUniversalTime();
        });
        await Repository.SaveChangesAsync();
        NService.ReleaseNotification(NotificationName.StepTimeReset);
    }
}
